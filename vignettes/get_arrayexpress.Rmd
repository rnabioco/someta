---
title: 'single cell GEO records'
date: '`r Sys.Date()`'
# package: scmetadata
author:
  - name: Rui Fu
    affiliation: RNA Bioscience Initative, University of Colorado School of Medicine
output:
  BiocStyle::html_document:
    toc_float: true

vignette: >
    %\VignetteIndexEntry{Introduction to clustifyr}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}  
---

```{r "knitr options", echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  fig.align = "center",
  comment = "#>",
  crop = NULL
)
```

```{r load}
library(here)
library(tidyverse)
date <- format(format = "%m%d%y", Sys.Date())
```

# Current ArrayExpress query used: 
```
exptype:"RNA-seq of coding RNA from single cells"
```

# Parse GEO query

```{r entries, eval = FALSE}
#source(here("utils", "geo_query.R"))
ae <- read_tsv(here("inst", "extdata", "ArrayExpress-Experiments-200920-205717.txt")) %>%
  filter(str_detect(Organism, "Homo sapiens") | str_detect(Organism, "Mus musculus"))
check_cell_type("E-MTAB-5953")
check_cell_type <- function(id) {
  temp <- suppressMessages(read_tsv(paste0("https://www.ebi.ac.uk/arrayexpress/files/", id, "/", id, ".sdrf.txt")))
  any(str_detect(colnames(temp), "inferred cell type"))
}
check_cell_type("E-MTAB-5953")

checks <- map(ae$Accession %>% setNames(ae$Accession),
              check_cell_type)

ae$usable <- unlist(checks)
ae<- ae %>% mutate(usable = ifelse(usable, "yes", "no"))
write_tsv(ae, here("inst", "extdata", "arrayexpress_092020.tsv"))
```

```{r}
ae <- read_tsv(here("inst", "extdata", "arrayexpress_092020.tsv"))
```

The fraction of ArrayExpress entries with "inferred cell type" column in sample metadata is `r (ae$usable == "yes") %>% mean()`.

# Parse database from Svensson et al.

```{r curated}
library(googlesheets4)
gs4_deauth()
data <- read_sheet("https://docs.google.com/spreadsheets/d/1En7-UV0k0laDiIfjFkdn7dggyR7jIk3WH8QgXaMOZF0", sheet = "Data")
hm_data <- data %>% filter(Measurement == "RNA-seq") %>% filter(str_detect(`Data location`, "^E-MTAB")) %>% filter(str_detect(Organism, "Human") | str_detect(Organism, "Mouse"))
hm_ids <- hm_data$`Data location` %>% strsplit(", ") %>% unlist()
```

Overlap of human and mouse scRNA-seq ArrayExpress entries between manual curation and the ArrayExpress query is `r mean(hm_ids %in% ae$Accession)`. (Old data presumably before new experiment type was implemented, and different organism annotated)


```{r frac}
frac <- ae %>% 
  group_by(year, usable) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  pivot_wider(names_from = usable, values_from = n) %>% 
  replace_na(list(no = 0, yes = 0)) %>% 
  mutate(fraction = yes/(yes + no), total = yes + no) %>% 
  mutate(fraction = round(fraction, digits = 3))

ggplot(ae,
       aes(x = year, fill = usable)) +
  geom_bar() +
  scale_fill_viridis_d(option = "plasma") +
  geom_text(data = frac, color = "black", aes(x = year, y = total + 5, label = fraction, fill = NA)) +
  cowplot::theme_cowplot() +
  ggtitle("scRNAseq datasets by year")
```